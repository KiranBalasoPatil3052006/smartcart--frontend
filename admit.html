<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Security-Policy"
        content="connect-src 'self' https://smart-cart-app-h47v.onrender.com http://localhost:5000;">
    <title>Smart Cart - Admin Dashboard</title>
    <link rel="stylesheet" href="AdmitStyle.css" />
    <link rel="icon" type="image/x-icon" href="images/favicon.ico" />
</head>

<body>
    <script>
        if (!localStorage.getItem('adminLoggedIn')) {
            window.location.href = 'adminlogin.html';
        }
    </script>

    <!-- TOP BAR (HEADER) -->
    <header class="top-bar">
        <div class="top-bar-left">
            <div class="menu-toggle" onclick="toggleMenu()">
                <span></span><span></span><span></span>
            </div>
            <span class="brand-name">Smart Cart Admin</span>
        </div>
        <div class="profile-icon">A</div>
    </header>

    <!-- SIDEBAR NAVIGATION -->
    <nav id="sideMenu">
        <div class="sidebar-top">
            <div class="sidebar-header">
                <h3>Menu</h3>
            </div>
            <div class="menu-toggle dark open" onclick="toggleMenu()">
                <!-- Close icon visual is handled by CSS transform of spans -->
                <span></span><span></span><span></span>
            </div>
        </div>
        <ul>
            <li onclick="showMainPage()">
                <svg class="sidebar-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                <span>Dashboard</span>
            </li>
            <li onclick="showProductManagement()">
                <svg class="sidebar-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="12" y1="8" x2="12" y2="16"></line>
                    <line x1="8" y1="12" x2="16" y2="12"></line>
                </svg>
                <span>Manage Products</span>
            </li>
            <li onclick="showBarcodeGenerator()">
                <svg class="sidebar-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <rect x="3" y="5" width="2" height="14"></rect>
                    <rect x="8" y="5" width="2" height="14"></rect>
                    <rect x="12" y="5" width="3" height="14"></rect>
                    <rect x="17" y="5" width="1" height="14"></rect>
                    <rect x="20" y="5" width="1" height="14"></rect>
                </svg>
                <span>Generate UPC-A</span>
            </li>
            <li onclick="showCashPayments()">
                <!-- Banknote/Cash Icon -->
                <svg class="sidebar-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <rect x="2" y="6" width="20" height="12" rx="2"></rect>
                    <circle cx="12" cy="12" r="2"></circle>
                    <path d="M6 12h.01M18 12h.01"></path>
                </svg>
                <span>Cash Payments</span>
            </li>
            <li onclick="showOnlinePayments()">
                <!-- Credit Card Icon -->
                <svg class="sidebar-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                    <line x1="1" y1="10" x2="23" y2="10"></line>
                </svg>
                <span>Online Payments</span>
            </li>
            <li onclick="showCashierCodes()">
                <!-- Key/Code Icon -->
                <svg class="sidebar-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path
                        d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4">
                    </path>
                </svg>
                <span>Cashier Codes</span>
            </li>
            <li onclick="showSales()">
                <!-- Chart/Graph Icon for Sales -->
                <svg class="sidebar-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <line x1="12" y1="20" x2="12" y2="10"></line>
                    <line x1="18" y1="20" x2="18" y2="4"></line>
                    <line x1="6" y1="20" x2="6" y2="16"></line>
                </svg>
                <span>Show Sales</span>
            </li>
            <li onclick="showCustomers()">
                <svg class="sidebar-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                <span>Customers</span>
            </li>
            <li>
                <a href="adminlogin.html"
                    style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 15px; width: 100%;">
                    <svg class="sidebar-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    <span>Logout</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- OVERLAY FOR MOBILE -->
    <div id="pageOverlay" class="overlay" onclick="toggleMenu()"></div>

    <!-- MAIN CONTENT -->
    <main class="main-content" id="mainContent">
        <div class="container">
            <!-- MESSAGE BOX -->
            <div id="messageBox"></div>

            <!-- TOP HEADER (Title + Back Button) -->
            <div id="page-header"
                style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; position: relative;">
                <button id="back-btn" class="btn"
                    style="display:none; padding: 8px 16px; font-size: 0.85rem; width: auto;" onclick="backToHome()">
                    ← Back
                </button>
                <h1 class="admin-heading" style="margin: 0 auto;">Admin Dashboard</h1>
            </div>

            <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">

            <!-- ========================= PRODUCT MANAGEMENT SECTION ========================= -->
            <div id="product-manage-section" style="display:none;">
                <h2 style="text-align:center; color: var(--primary-color);">Product Management</h2>

                <!-- Add Product -->
                <form id="add-product-form">
                    <h3 style="margin-bottom: 15px;">Add New Product</h3>
                    <div class="form-group">
                        <label>Product Name</label>
                        <input type="text" id="product-name" placeholder="Enter product name" required />
                    </div>
                    <div class="form-group">
                        <label>Barcode (UPC-A)</label>
                        <input type="text" id="product-barcode" placeholder="12-digit barcode" required pattern="\d{12}"
                            maxlength="12" />
                    </div>
                    <div class="form-group">
                        <label>Price (₹)</label>
                        <input type="number" id="product-price" placeholder="0.00" min="0" step="0.01" required />
                    </div>
                    <button type="submit" class="btn" style="width:100%">Add Product</button>
                </form>

                <!-- Search Bar -->
                <div class="search-container">
                    <input type="text" id="barcode-search" placeholder="Search by Barcode..." maxlength="12" />
                    <button id="search-btn" class="btn">Search</button>
                </div>

                <!-- Product Table -->
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Barcode</th>
                                <th>Name</th>
                                <th>Price</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="product-table-body"></tbody>
                    </table>
                </div>

                <!-- Edit Modal -->
                <div id="edit-modal" class="modal">
                    <div class="modal-content">
                        <span class="close" onclick="closeEditModal()">&times;</span>
                        <h2 style="margin-bottom: 15px;">Edit Product</h2>
                        <form id="edit-product-form" style="box-shadow:none; padding:0; border:none; margin:0;">
                            <input type="hidden" id="edit-product-id" />
                            <div class="form-group">
                                <label>Product Name</label>
                                <input type="text" id="edit-product-name" required />
                            </div>
                            <div class="form-group">
                                <label>Barcode (UPC-A)</label>
                                <input type="text" id="edit-product-barcode" readonly
                                    style="background-color: #f0f0f0;" />
                            </div>
                            <div class="form-group">
                                <label>Price (₹)</label>
                                <input type="number" id="edit-product-price" min="0" step="0.01" required />
                            </div>
                            <button type="submit" class="btn" style="width:100%">Save Changes</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- ========================= BARCODE GENERATOR SECTION ========================= -->
            <div id="barcode-generator-section" style="display:none;">
                <h2 style="text-align:center; color: var(--primary-color);">Generate UPC-A Barcode</h2>

                <div
                    style="max-width: 500px; margin: 30px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid #eee;">
                    <div class="form-group">
                        <label>Enter Barcode Number</label>
                        <input type="text" id="upc-input" placeholder="e.g. 123456789012" maxlength="12"
                            style="width: 100%; height:45px; margin-bottom: 20px;">
                    </div>
                    <button class="btn" style="width: 100%; margin-bottom: 25px;"
                        onclick="generateUPC()">Generate</button>

                    <div
                        style="text-align: center; min-height: 150px; display: flex; align-items: center; justify-content: center; border: 2px dashed #e0e0e0; border-radius: 10px; background: #fafafa; padding: 10px;">
                        <svg id="standalone-barcode" style="display:none; width: 100%; height: auto;"></svg>
                        <p id="barcode-placeholder" style="color: #aaa; font-weight: 600;">Barcode Preview</p>
                    </div>

                    <div id="barcode-actions"
                        style="display:none; justify-content: center; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                        <button class="btn" style="background-color: #555; border-color: #555;"
                            onclick="printBarcode()">Print</button>
                        <button class="btn" style="background-color: #007bff; border-color: #007bff;"
                            onclick="downloadBarcode('png')">Download PNG</button>
                        <button class="btn" style="background-color: #28a745; border-color: #28a745;"
                            onclick="downloadBarcode('jpg')">Download JPG</button>
                        <button class="btn" style="background-color: #ff9800; border-color: #ff9800;"
                            onclick="addProductFromBarcode()">Add Product</button>
                    </div>
                </div>
            </div>

            <!-- ========================= CUSTOMERS SECTION ========================= -->
            <div id="customer-section" style="display:none;">
                <h2 style="text-align:center; color: var(--primary-color);">All Customers</h2>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Mobile</th>
                                <th>Email</th>
                            </tr>
                        </thead>
                        <tbody id="customer-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- ========================= CASHIER CODES SECTION ========================= -->
            <div id="cashier-code-display" style="display:none;">
                <h2 style="text-align:center; color: var(--primary-color);">Pending Cashier Codes</h2>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Mobile</th>
                                <th>Cashier Code</th>
                                <th>Date Created</th>
                            </tr>
                        </thead>
                        <tbody id="pending-code-body"></tbody>
                    </table>
                </div>

                <h2 style="text-align:center; color: var(--primary-color); margin-top:30px;">Verified Cashier Codes</h2>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Mobile</th>
                                <th>Cashier Code</th>
                                <th>Date Verified</th>
                            </tr>
                        </thead>
                        <tbody id="verified-code-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- ========================= SHOW SALES SECTION ========================= -->
            <div id="show-sales-section" style="display:none;">
                <h2 style="text-align:center; color: var(--primary-color);">Today's Sales</h2>

                <div class="search-container" style="justify-content: flex-end; margin-bottom: 10px;">
                    <label style="margin-right: 10px; font-weight:bold;">Filter Date:</label>
                    <input type="date" id="sales-date-picker"
                        style="padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                    <button class="btn" onclick="fetchSalesByDate()"
                        style="margin-left: 10px; padding: 8px 15px;">Go</button>
                </div>

                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Mobile</th>
                                <th>Amount</th>
                                <th>Time</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="sales-list-body"></tbody>
                    </table>
                </div>

                <!-- Sales Detail Modal -->
                <div id="sales-detail-modal" class="modal">
                    <div class="modal-content" style="max-width: 600px;">
                        <span class="close" onclick="closeSalesModal()">&times;</span>
                        <h3 id="sales-detail-title" style="margin-bottom: 15px; color: var(--primary-color);">Purchase
                            Details</h3>
                        <div class="table-responsive">
                            <table style="font-size: 0.9rem;">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Price</th>
                                        <th>Qty</th>
                                        <th>Original Total</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="sales-detail-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========================= PURCHASE SUMMARY & HISTORY ========================= -->
            <div id="summary-history-section">
                <h2 id="summary-title" style="text-align:center; color: var(--primary-color);">Customer Purchase Summary
                </h2>
                <div class="table-responsive">
                    <table id="summary-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Mobile</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Amount</th>
                                <th>Payment</th>
                            </tr>
                        </thead>
                        <tbody id="summary-body"></tbody>
                    </table>
                </div>

                <h2 id="history-title" style="text-align:center; color: var(--primary-color); margin-top:30px;">Recent
                    Product Sales</h2>
                <div class="table-responsive">
                    <table id="history-table">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Barcode</th>
                                <th>Product</th>
                                <th>Price</th>
                                <th>Qty</th>
                                <th>Total</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="history-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

    <script>
        // DOM Elements
        const messageBox = document.getElementById("messageBox");
        const barcodeSearchInput = document.getElementById("barcode-search");
        const searchBtn = document.getElementById("search-btn");
        const productTableBody = document.getElementById("product-table-body");
        const sideMenu = document.getElementById("sideMenu");
        const pageOverlay = document.getElementById("pageOverlay");
        const mainContent = document.getElementById("mainContent");

        // UI Functions
        function toggleMenu() {
            sideMenu.classList.toggle("active");
            pageOverlay.classList.toggle("show");

            // Toggle hamburger icon state
            const toggles = document.querySelectorAll('.menu-toggle');
            toggles.forEach(t => t.classList.toggle("open"));
        }

        function showMessage(msg, type) {
            messageBox.textContent = msg;
            messageBox.className = type === "success" ? "success" : "error";
            messageBox.style.display = "block";
            // Scroll to top to see message
            window.scrollTo({ top: 0, behavior: 'smooth' });
            setTimeout(() => messageBox.style.display = "none", 4000);
        }

        // Navigation & Views
        function resetView() {
            const sections = [
                "summary-history-section",
                "customer-section",
                "cashier-code-display",
                "product-manage-section",
                "cashier-code-display",
                "product-manage-section",
                "barcode-generator-section",
                "show-sales-section"
            ];
            sections.forEach(id => document.getElementById(id).style.display = "none");

            // Show global back button by default for all sub-pages
            document.getElementById("back-btn").style.display = "block";
            document.getElementById("back-btn").innerHTML = "Back";

            // Clear tables
            document.getElementById("summary-body").innerHTML = "";
            document.getElementById("history-body").innerHTML = "";
            document.getElementById("customer-body").innerHTML = "";
            document.getElementById("pending-code-body").innerHTML = "";
            document.getElementById("verified-code-body").innerHTML = "";

            // Close sidebar on mobile after selection
            if (window.innerWidth <= 768) {
                sideMenu.classList.remove("active");
                pageOverlay.classList.remove("show");
                document.querySelectorAll('.menu-toggle').forEach(t => t.classList.remove("open"));
            }
        }

        function backToHome() {
            resetView(); // This shows back button, but we hide it immediately next line
            document.getElementById("summary-history-section").style.display = "block";
            document.getElementById("summary-title").innerText = "Customer Purchase Summary";
            document.getElementById("back-btn").style.display = "none"; // Hide on home
            // Reset Main Title
            document.querySelector(".admin-heading").innerText = "Admin Dashboard";

            loadFullPurchaseHistory();
        }

        function showMainPage() {
            backToHome();
        }

        function showBarcodeGenerator() {
            resetView();
            document.getElementById("barcode-generator-section").style.display = "block";
            document.querySelector(".admin-heading").innerText = "Barcode Generator";
            document.getElementById("upc-input").value = "";
            document.getElementById("standalone-barcode").style.display = 'none';
            document.getElementById("barcode-placeholder").style.display = 'block';
            document.getElementById("barcode-actions").style.display = 'none';
        }

        function generateUPC() {
            const input = document.getElementById("upc-input");
            const val = input.value.trim();
            const placeholder = document.getElementById("barcode-placeholder");
            const svg = document.getElementById("standalone-barcode");

            if (!/^\d{11,12}$/.test(val)) {
                showMessage("Please enter valid 11 or 12 digit number", "error");
                return;
            }

            try {
                JsBarcode("#standalone-barcode", val, {
                    format: "upc",
                    lineColor: "#000",
                    width: 2,
                    height: 100,
                    displayValue: true,
                    fontOptions: "bold",
                    fontSize: 18,
                    background: "#ffffff"
                });
                svg.style.display = 'block';
                placeholder.style.display = 'none';

                // Show action buttons
                document.getElementById("barcode-actions").style.display = "flex";
            } catch (e) {
                console.error(e);
                showMessage("Could not generate barcode (Invalid digit?)", "error");
                svg.style.display = 'none';
                placeholder.style.display = 'block';
                document.getElementById("barcode-actions").style.display = "none";
            }
        }

        function printBarcode() {
            const svg = document.getElementById("standalone-barcode");
            const serializer = new XMLSerializer();
            const svgString = serializer.serializeToString(svg);

            const win = window.open('', '', 'height=500,width=500');
            win.document.write('<html><head><title>Print Barcode<\/title>');
            win.document.write('<\/head><body style="display:flex;justify-content:center;align-items:center;height:100vh;">');
            win.document.write(svgString);
            win.document.write('<\/body><\/html>');
            win.document.close();
            win.focus();
            // Wait for content to load then print
            setTimeout(() => {
                win.print();
                win.close();
            }, 500);
        }

        function downloadBarcode(format) {
            const svg = document.getElementById("standalone-barcode");
            const serializer = new XMLSerializer();

            // Get the actual SVG dimensions
            const svgRect = svg.getBoundingClientRect();
            const width = svgRect.width * 2; // 2x for better resolution
            const height = svgRect.height * 2;

            const svgString = serializer.serializeToString(svg);
            const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(svgBlob);

            const img = new Image();
            img.onload = function () {
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');

                // Always fill white background for both PNG and JPG (barcodes need white bg)
                ctx.fillStyle = "#FFFFFF";
                ctx.fillRect(0, 0, width, height);

                ctx.drawImage(img, 0, 0, width, height);

                const imgData = canvas.toDataURL(`image/${format === 'jpg' ? 'jpeg' : 'png'}`);
                const link = document.createElement('a');
                link.href = imgData;
                link.download = `barcode.${format}`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };
            img.src = url;
        }

        function addProductFromBarcode() {
            const barcodeValue = document.getElementById("upc-input").value.trim();
            if (!barcodeValue) {
                showMessage("No barcode to add", "error");
                return;
            }
            // Navigate to Product Management
            showProductManagement();
            // Pre-fill the barcode input
            document.getElementById("product-barcode").value = barcodeValue;
            // Focus on product name field so user can start typing
            document.getElementById("product-name").focus();
        }

        // ========== PRODUCT MANAGEMENT ==========
        function showProductManagement() {
            resetView();
            document.getElementById("product-manage-section").style.display = "block";
            fetchProducts();
            clearProductForm();
            clearSearch();
        }

        function clearProductForm() {
            document.getElementById("add-product-form").reset();
        }

        function clearSearch() {
            barcodeSearchInput.value = "";
        }

        function fetchProducts(searchBarcode = null) {
            fetch(`${BASE_URL}/products`)
                .then(res => res.json())
                .then(products => {
                    const tbody = productTableBody;
                    tbody.innerHTML = "";

                    if (searchBarcode) {
                        const foundIndex = products.findIndex(p => p.barcode === searchBarcode);
                        if (foundIndex === -1) {
                            showMessage("Product not found", "error");
                        } else {
                            const foundProd = products.splice(foundIndex, 1)[0];
                            products.unshift(foundProd);
                        }
                    }

                    products.forEach(prod => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                          <td data-label="Barcode">${prod.barcode}</td>
                          <td data-label="Name">${prod.name}</td>
                          <td data-label="Price">₹${Number(prod.price).toFixed(2)}</td>
                          <td data-label="Actions">
                            <button class="btn" style="padding: 5px 10px; font-size: 0.9rem;" onclick="showEditModal('${prod._id}')">Edit</button>
                            <button class="btn" style="padding: 5px 10px; font-size: 0.9rem; background: #d9534f; border-color: #d9534f;" onclick="deleteProduct('${prod._id}')">Delete</button>
                          </td>`;

                        if (searchBarcode && prod.barcode === searchBarcode) {
                            row.style.backgroundColor = "#fff9c4"; // Highlight
                            setTimeout(() => row.style.backgroundColor = "", 2000);
                        }
                        tbody.appendChild(row);
                    });
                })
                .catch(() => showMessage("Failed to load products", "error"));
        }

        searchBtn.addEventListener("click", () => {
            const searchVal = barcodeSearchInput.value.trim();
            if (!/^\d{12}$/.test(searchVal)) {
                if (searchVal.length === 0) fetchProducts();
                else showMessage("Invalid barcode format (must be 12 digits)", "error");
                return;
            }
            fetchProducts(searchVal);
        });

        barcodeSearchInput.addEventListener("keydown", e => {
            if (e.key === "Enter") {
                e.preventDefault();
                searchBtn.click();
            }
        });

        document.getElementById("add-product-form").addEventListener("submit", e => {
            e.preventDefault();
            const name = document.getElementById("product-name").value.trim();
            const barcode = document.getElementById("product-barcode").value.trim();
            const price = parseFloat(document.getElementById("product-price").value);

            fetch(`${BASE_URL}/product`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name, barcode, price })
            })
                .then(res => res.json())
                .then(data => {
                    showMessage(data.message, data.success ? "success" : "error");
                    if (data.success) {
                        clearProductForm();
                        fetchProducts();
                    }
                })
                .catch(() => showMessage("Error adding product.", "error"));
        });

        function showEditModal(productId) {
            fetch(`${BASE_URL}/product/id/${productId}`)
                .then(res => res.json())
                .then(prod => {
                    document.getElementById("edit-product-id").value = prod._id;
                    document.getElementById("edit-product-name").value = prod.name;
                    document.getElementById("edit-product-barcode").value = prod.barcode;
                    document.getElementById("edit-product-price").value = prod.price;
                    document.getElementById("edit-modal").style.display = "flex";
                })
                .catch(() => showMessage("Failed to load product details", "error"));
        }

        document.getElementById("edit-product-form").addEventListener("submit", e => {
            e.preventDefault();
            const id = document.getElementById("edit-product-id").value;
            const name = document.getElementById("edit-product-name").value.trim();
            const price = parseFloat(document.getElementById("edit-product-price").value);

            fetch(`${BASE_URL}/product/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name, price })
            })
                .then(res => res.json())
                .then(data => {
                    showMessage(data.message, data.success ? "success" : "error");
                    if (data.success) {
                        closeEditModal();
                        fetchProducts();
                    }
                })
                .catch(() => showMessage("Error updating product.", "error"));
        });

        function deleteProduct(id) {
            if (!confirm("Are you sure you want to delete this product?")) return;
            fetch(`${BASE_URL}/product/${id}`, { method: "DELETE" })
                .then(res => res.json())
                .then(data => {
                    showMessage(data.message, data.success ? "success" : "error");
                    if (data.success) fetchProducts();
                })
                .catch(() => showMessage("Error deleting product.", "error"));
        }

        function closeEditModal() {
            document.getElementById("edit-modal").style.display = "none";
        }

        // ========== CUSTOMERS ==========
        function showCustomers() {
            resetView();
            document.getElementById("customer-section").style.display = "block";
            fetch(`${BASE_URL}/customers`)
                .then(res => res.json())
                .then(data => {
                    const body = document.getElementById("customer-body");
                    if (data.length === 0) {
                        body.innerHTML = "<tr><td colspan='3'>No customers found</td></tr>";
                        return;
                    }
                    data.forEach(c => {
                        const row = document.createElement("tr");
                        row.innerHTML = `<td data-label="Name">${c.name}</td><td data-label="Mobile">${c.mobile}</td><td data-label="Email">${c.email}</td>`;
                        body.appendChild(row);
                    });
                })
                .catch(() => showMessage("Failed to load customers", "error"));
        }

        // ========== PURCHASE HISTORY & SUMMARY ==========
        function loadFullPurchaseHistory() {
            fetch(`${BASE_URL}/purchase-history`)
                .then(res => res.json())
                .then(renderPurchaseHistory)
                .catch(() => showMessage("Failed to load purchase history", "error"));
        }

        function renderPurchaseHistory(data) {
            const summaryBody = document.getElementById("summary-body");
            const historyBody = document.getElementById("history-body");
            summaryBody.innerHTML = "";
            historyBody.innerHTML = "";

            if (data.length === 0) {
                summaryBody.innerHTML = "<tr><td colspan='6'>No purchase history</td></tr>";
                historyBody.innerHTML = "<tr><td colspan='7'>No products sold yet</td></tr>";
                return;
            }

            data.forEach(entry => {
                let total = 0;
                entry.products.forEach(p => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td data-label="Customer">${entry.name}</td>
                        <td data-label="Barcode">${p.barcode}</td>
                        <td data-label="Product">${p.name}</td>
                        <td data-label="Price">₹${p.price}</td>
                        <td data-label="Qty">${p.quantity}</td>
                        <td data-label="Total">₹${(p.price * p.quantity).toFixed(2)}</td>
                        <td data-label="Date">${new Date(entry.date).toLocaleDateString()}</td>`;
                    historyBody.appendChild(row);
                    total += p.price * p.quantity;
                });

                const date = new Date(entry.date);
                const sumRow = document.createElement("tr");
                const paymentInfo = `${entry.paymentMethod || 'Cash'} ${entry.paymentMethod === 'cash' ? `(${entry.cashierCode || 'N/A'})` : ''}`;

                sumRow.innerHTML = `
                    <td data-label="Name">${entry.name}</td>
                    <td data-label="Mobile">${entry.mobile}</td>
                    <td data-label="Date">${date.toLocaleDateString()}</td>
                    <td data-label="Time">${date.toLocaleTimeString()}</td>
                    <td data-label="Amount">₹${total.toFixed(2)}</td>
                    <td data-label="Payment">${paymentInfo}</td>`;
                summaryBody.appendChild(sumRow);
            });
        }

        function showCashPayments() {
            resetView();
            document.getElementById("summary-history-section").style.display = "block";
            // Update title
            document.getElementById("summary-title").innerText = "Cash Payments";
            document.querySelector(".admin-heading").innerText = "Cash Payments";

            fetch(`${BASE_URL}/purchases/cash`)
                .then(res => res.json())
                .then(data => {
                    renderPurchaseHistory(data);
                    loadPendingCash(); // Load pending cash requests concurrently
                })
                .catch(() => showMessage("Failed to load cash payments", "error"));
        }

        function loadPendingCash() {
            fetch(`${BASE_URL}/cash-intents`)
                .then(res => res.json())
                .then(data => {
                    const summaryBody = document.getElementById("summary-body");
                    // Append pending intents to summary table
                    data.forEach(intent => {
                        const row = document.createElement("tr");
                        row.classList.add("pending-row"); // Could style this if needed
                        row.style.borderLeft = "4px solid orange";
                        row.innerHTML = `
                            <td data-label="Name">${intent.name || 'Unknown'}</td>
                            <td data-label="Mobile">${intent.mobile}</td>
                            <td data-label="Date">${new Date(intent.date).toLocaleDateString()}</td>
                            <td data-label="Time">PENDING</td>
                            <td data-label="Amount">--</td>
                            <td data-label="Payment"><strong>Pending via Cashier Code: ${intent.cashierCode}</strong></td>`;
                        summaryBody.prepend(row); // Show pending at top
                    });
                });
        }

        function showOnlinePayments() {
            resetView();
            document.getElementById("summary-history-section").style.display = "block";
            document.getElementById("summary-title").innerText = "Online Payments";
            document.querySelector(".admin-heading").innerText = "Online Payments";

            fetch(`${BASE_URL}/purchases/online`)
                .then(res => res.json())
                .then(renderPurchaseHistory)
                .catch(() => showMessage("Failed to load online payments", "error"));
        }

        // ========== CASHIER CODES ==========
        function showCashierCodes() {
            resetView();
            document.getElementById("cashier-code-display").style.display = "block";

            // Pending
            fetch(`${BASE_URL}/cash-intents`)
                .then(res => res.json())
                .then(data => {
                    const pendingBody = document.getElementById("pending-code-body");
                    pendingBody.innerHTML = "";
                    if (data.length === 0) pendingBody.innerHTML = "<tr><td colspan='3'>No pending codes</td></tr>";

                    data.forEach(intent => {
                        const row = document.createElement("tr");
                        row.innerHTML = `<td data-label="Mobile">${intent.mobile}</td><td data-label="Code" style="font-weight:bold; font-size:1.1rem; color:green;">${intent.cashierCode}</td><td data-label="Created">${new Date(intent.date).toLocaleString()}</td>`;
                        pendingBody.appendChild(row);
                    });
                });

            // History
            fetch(`${BASE_URL}/cashier-code-history`)
                .then(res => res.json())
                .then(history => {
                    const verifiedBody = document.getElementById("verified-code-body");
                    verifiedBody.innerHTML = "";
                    if (history.length === 0) verifiedBody.innerHTML = "<tr><td colspan='3'>No history</td></tr>";

                    history.forEach(entry => {
                        const row = document.createElement("tr");
                        row.innerHTML = `<td data-label="Mobile">${entry.mobile}</td><td data-label="Code">${entry.cashierCode}</td><td data-label="Verified">${new Date(entry.createdAt).toLocaleString()}</td>`;
                        verifiedBody.appendChild(row);
                    });
                });
        }

        // ========== SHOW SALES ==========
        let currentPurchaseId = null;

        function showSales() {
            resetView();
            document.getElementById("show-sales-section").style.display = "block";
            const today = new Date().toISOString().split('T')[0];
            document.getElementById("sales-date-picker").value = today;
            fetchSalesByDate(today);
            document.querySelector(".admin-heading").innerText = "Sales Management";
        }

        function fetchSalesByDate(dateInput) {
            const date = dateInput || document.getElementById("sales-date-picker").value;
            if (!date) return;

            fetch(`${BASE_URL}/purchase-history?date=${date}`)
                .then(res => res.json())
                .then(data => {
                    const tbody = document.getElementById("sales-list-body");
                    tbody.innerHTML = "";
                    if (data.length === 0) {
                        tbody.innerHTML = "<tr><td colspan='5'>No sales found for this date</td></tr>";
                        return;
                    }

                    data.forEach(p => {
                        let total = 0;
                        if (p.products && p.products.length > 0) {
                            total = p.products.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                        }

                        const row = document.createElement("tr");
                        row.innerHTML = `
                            <td data-label="Name">${p.name}</td>
                            <td data-label="Mobile">${p.mobile}</td>
                            <td data-label="Amount">₹${total.toFixed(2)}</td>
                            <td data-label="Time">${new Date(p.date).toLocaleTimeString()}</td>
                            <td data-label="Action">
                                <button class="btn" style="padding: 5px 10px; font-size: 0.85rem;" onclick='openSalesDetail(${JSON.stringify(p._id)})'>View / Edit</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(() => showMessage("Failed to load sales", "error"));
        }

        function openSalesDetail(purchaseId) {
            currentPurchaseId = purchaseId;
            const date = document.getElementById("sales-date-picker").value;
            fetch(`${BASE_URL}/purchase-history?date=${date}`)
                .then(res => res.json())
                .then(data => {
                    const purchase = data.find(p => p._id === purchaseId);
                    if (purchase) {
                        renderSalesDetail(purchase);
                        document.getElementById("sales-detail-modal").style.display = "flex";
                    } else {
                        showMessage("Purchase not found (might be deleted)", "error");
                        fetchSalesByDate(); // Refresh list
                    }
                });
        }

        function renderSalesDetail(purchase) {
            currentPurchaseId = purchase._id;
            const tbody = document.getElementById("sales-detail-body");
            tbody.innerHTML = "";
            document.getElementById("sales-detail-title").innerText = `Details for ${purchase.name}`;

            if (!purchase.products || purchase.products.length === 0) {
                tbody.innerHTML = "<tr><td colspan='5'>No products (Purchase Empty)</td></tr>";
                return;
            }

            purchase.products.forEach(p => {
                const row = document.createElement("tr");
                row.innerHTML = `
                   <td>${p.name} <br><small>${p.barcode}</small></td>
                   <td>₹${p.price}</td>
                   <td>${p.quantity}</td>
                   <td>₹${(p.price * p.quantity).toFixed(2)}</td>
                   <td>
                       <button class="btn" style="background:#d9534f; border-color:#d9534f; font-size:0.8rem; padding: 4px 8px;"
                               onclick="removeProduct('${p.barcode}')">Remove</button>
                   </td>
                `;
                tbody.appendChild(row);
            });
        }

        function removeProduct(barcode) {
            if (!confirm("Are you sure you want to remove this product? The total will be updated.")) return;

            fetch(`${BASE_URL}/purchase/${currentPurchaseId}/remove-product`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ barcode })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showMessage("Product removed", "success");
                        if (data.purchase) {
                            renderSalesDetail(data.purchase);
                            // Also refresh main list to show updated total hidden in background
                            fetchSalesByDate();
                        } else {
                            // Purchase rejected/deleted
                            closeSalesModal();
                            fetchSalesByDate();
                            showMessage("Purchase deleted as it became empty", "success");
                        }
                    } else {
                        showMessage(data.message, "error");
                    }
                })
                .catch(err => showMessage("Error removing product", "error"));
        }

        function closeSalesModal() {
            document.getElementById("sales-detail-modal").style.display = "none";
        }

        // Init
        document.addEventListener("DOMContentLoaded", () => {
            loadFullPurchaseHistory();
        });
    </script>
</body>

</html>